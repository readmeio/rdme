name: CI

on:
  push:
    branches:
      - main
      - next
  pull_request:

jobs:
  build:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 14
          - 16
          - 18
          - 20

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build dist
        run: npm run build

      - name: Run tests
        run: npm test

  action:
    name: GitHub Action Dry Run
    runs-on: ubuntu-latest
    continue-on-error: true # TODO: remove this!
    steps:
      - name: Checkout GitHub Action
        uses: actions/checkout@v3
        with:
          path: rdme-repo

      - name: Checkout external repo containing OpenAPI file
        uses: actions/checkout@v3
        with:
          path: oas-examples-repo
          repository: readmeio/oas-examples

      # For every GitHub Action release, we deploy our Docker images
      # to the GitHub Container Registry for performance reasons.
      # Instead of testing against the pre-built image, we can build
      # an image from the currently checked-out repo contents by doing a
      # li'l update in the action.yml file to point to the current Dockerfile.
      - name: Replace Docker image value in action.yml
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: 'image:.*'
          replace: "image: 'Dockerfile'"
          include: rdme-repo/action.yml

      - name: Run `openapi:validate` command
        uses: ./rdme-repo/
        with:
          rdme: openapi:validate oas-examples-repo/3.1/json/petstore.json

      - name: Run `openapi:validate` with filename in quotes
        uses: ./rdme-repo/
        with:
          rdme: openapi:validate "oas-examples-repo/3.1/json/petstore.json"

      # TODO: Maybe remove this
      - name: Run `openapi:validate` on file in rdme repo (take 1)
        uses: ./rdme-repo/
        with:
          rdme: openapi:validate rdme-repo/__tests__/__fixtures__/petstore-simple-weird-version.json

      # TODO: Maybe remove this
      - name: Run `openapi:validate` on file in rdme repo (take 2)
        uses: ./rdme-repo/
        with:
          rdme: openapi:validate ${{ github.workspace }}/rdme-repo/__tests__/__fixtures__/petstore-simple-weird-version.json

      # TODO: Maybe remove this
      - name: Run `openapi:validate` on file in rdme repo (take 3)
        uses: ./rdme-repo/
        with:
          rdme: openapi:validate ${{ github.workspace }}/./rdme-repo/__tests__/__fixtures__/petstore-simple-weird-version.json

      - name: Run `openapi:validate` on file with refs
        uses: ./rdme-repo/
        with:
          rdme: openapi:validate ${{ github.workspace }}/rdme-repo/__tests__/__fixtures__/ref-oas/petstore.json --workingDirectory ${{ github.workspace }}/rdme-repo

      - name: Run `openapi:validate` on file with relative refs
        uses: ./rdme-repo/
        with:
          # TODO: this will need a workingDirectory parameter
          rdme: openapi:validate ${{ github.workspace }}/rdme-repo/__tests__/__fixtures__/relative-ref-oas/petstore.json --workingDirectory ${{ github.workspace }}/rdme-repo/__tests__/__fixtures__/relative-ref-oas

      # Docs: https://rdme-test.readme.io
      - name: Run `openapi` command
        uses: ./rdme-repo/
        with:
          rdme: openapi oas-examples-repo/3.1/json/petstore.json --key=${{ secrets.RDME_TEST_PROJECT_API_KEY }} --id=${{ secrets.RDME_TEST_PROJECT_API_SETTING }}

      - name: Run `openapi` command with weird arg syntax
        uses: ./rdme-repo/
        with:
          rdme: openapi "oas-examples-repo/3.1/json/petstore.json" --key "${{ secrets.RDME_TEST_PROJECT_API_KEY }}" --id=${{ secrets.RDME_TEST_PROJECT_API_SETTING }}
